#!/usr/bin/bash
# DECRYPTED BY TRC4@USA.COM
##################################################
###       Install VDOPanel Control Panel       ###
###       centos7 Installation                 ###
##################################################
#

ARGC=("$#")

clear
echo -e "\t\t      \033[36m___    ___   ________      _______   \033[0m"
echo -e "\t\t      \033[36m\  \  /  /  |  ____  \    / _____ \  \033[0m"
echo -e "\t\t      \033[36m \  \/  /   | |    \  |  | | \033[31m|'\ \033[0m\033[36m| | \033[0m"
echo -e "\t\t\033[31m█▀▀▀▀▀▀▀\033[0m\033[36m\    /    | |     | |  | | \033[31m|_/\033[0m \033[36m| |\033[0m\033[31m▀▀▀▀▀▀█\033[0m"
echo -e "\t\t\033[31m█\033[0m     \033[36m   \  /     | |____/  |  | |_____| | \033[0m     \033[31m█\033[0m"
echo -e "\t\t\033[31m█\033[0m     \033[36m    \/      |________/    \_______/  \033[0m     \033[31m█\033[0m"
echo -e "\t\t\033[31m█            ___                   _            █\033[0m"
echo -e "\t\t\033[31m█           | _ \ __ _  _ _   ___ | |           █\033[0m"
echo -e "\t\t\033[31m█           |  _// _\` || ' \ / -_)| |           █\033[0m"
echo -e "\t\t\033[31m▀▀▀▀▀▀▀▀▀▀▀▀|_|  \__,_||_||_|\___||_|▀▀▀▀▀▀▀▀▀▀▀▀\033[0m"
URL_VDO="https://vdopanel.com/dist"
VDO_VER=`curl -s ${URL_VDO}/ver.txt`
echo -e "\t\t                               v${VDO_VER}"

if [ $ARGC -ne 1 ]; then
	echo -e "\n\033[32mOptions :\033[0m\n\nStart install with this command : ./install.bin start\nfor uninstall : ./install.bin uninstall\n"
	exit -1
fi

export choose=$1

STATUS_POSITION="\033[60G"
CYAN="\033[36m"
RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"
TMP_F="/tmp/tmpinstall"
echo > ${TMP_F}

validation_func()
{
 if [ ${PID_STATUS} -ne 0 ]; then
	${1}
	echo -e "\nInstallation aborted, Try again or contact support for this error.\n\n ${RED} Error Details : \033[0m\n"
	cat ${TMP_F}
        exit -1
 else
        ${2}
 fi
}

SPINNER()
{
 PID=$!
 i=1
 sp="-\\|/"
 echo -n ' '
 while [ -d /proc/${PID} ]
 do
	printf "\b${sp:i++%${#sp}:1}"
 done
 wait ${PID}
 PID_STATUS=$?
}

if [ -f /etc/centos-release ]; then
	Centos_OS=`cat /etc/centos-release | awk '{print $4}' | cut -d"." -f1`
	if [ ${Centos_OS} != 7 ]; then
		echo -e "${RED} Your CentOS version not supported, this VDOPanel installation for CentOS 7 only.\033[0m\n"
		echo -e " Your current version is : CentOS ${Centos_OS}\n"
		exit -1
	fi
else
	echo -e "${RED} Your System not supported, this VDOPanel installation for CentOS 7 only.\033[0m\n"
	Current_SYS=`cat /etc/os-release | grep "PRETTY_NAME=" | cut -d"=" -f2`
	echo -e " Your current system is : ${Current_SYS}\n"
	exit -1
fi

cPanel_chk="/usr/local/cpanel/version"
if [ -f ${cPanel_chk} ]; then
	echo -e "${RED} This installation for centos 7 minimal servers only, Not cPanel servers.\033[0m\n"
	exit -1
fi

status_busy()
{
  echo -ne "$@  ${STATUS_POSITION}${CYAN} [ under progress ] \033[0m${NOCOL}"
}

status_done()
{
  echo -e "${STATUS_POSITION}${GREEN} [ installed done ]\033[0m \033[80G \033[0m${NOCOL}"
}

status_fail()
{
  echo -e "${STATUS_POSITION}${RED} [ fail ]          \033[0m \033[80G \033[0m${NOCOL}"
}

Source_L="https://vdopanel.com/dist"

CHK_SYS_busy()
{
  echo -ne "$@ ${CYAN}Checking System please wait... \033[0m${NOCOL}"
}

CHK_SYS_done()
{
  echo -e "\033[1G                                 \033[0m${NOCOL}"
}

function Elapsed_T_FUNC()
{
  local T=$1
  local D=$((T/60/60/24))
  local H=$((T/60/60%24))
  local M=$((T/60%60))
  local S=$((T%60))
  (( $D > 0 )) && printf '%d days ' $D
  (( $H > 0 )) && printf '%d hours ' $H
  (( $M > 0 )) && printf '%d minutes ' $M
  (( $D > 0 || $H > 0 || $M > 0 )) && printf 'and '
  printf '%d seconds\n' $S
}

if [ $choose = "start" ]; then
	CHK_SYS_busy
	yum -y install bind-utils >/dev/null 2>&1 &
	SPINNER;CHK_SYS_done
	SERV_IP=`dig TXT +short o-o.myaddr.l.google.com @ns1.google.com -4 | tr -d '"'`
	#SERV_IP=`ifconfig | sed -En 's/127.0.0.1//;s/.*inet (addr:)?(([0-9]*\.){3}[0-9]*).*/\2/p' | head -n1`
	if ! rpm -q net-tools > /dev/null; then
		CHK_SYS_busy
		yum -y install net-tools >/dev/null 2>&1 &
		SPINNER;CHK_SYS_done
	fi
	RECOMMENDED_="\033[32m[ RECOMMENDED ]\033[0m"
	NOT_RECOMMENDED_="\033[31m[ NOT RECOMMENDED ]\033[0m"
	SERVIPC="\033[35m${SERV_IP}\033[0m"
	echo -e "\n"
	echo -e "#####################################################################################" 1>&2
	echo -e "#                                                                                   #" 1>&2
	echo -e "#      Must point your domain or subdomain to server IP before resume install       #" 1>&2
	echo -e "#      Create A record for ex : domain.com or stream.domain.com ==> ${SERVIPC}      \033[85G#" 1>&2
	echo -e "#      So, get ready to start install.  ${RECOMMENDED_}                             #" 1>&2
	echo -e "#      Or you can resume install with server IP. ${NOT_RECOMMENDED_}                #" 1>&2
	echo -e "#                                                                                   #" 1>&2
	echo -e "#####################################################################################" 1>&2
	echo -e "\n"

	while true
	do
		read -p "Put [ y ] to confirm installation? [y/n] : " yn
		case $yn in
		[Yy]* )

		break;;
		[Nn]* ) echo -e "Installation has been canceled.\n";exit;;
		* ) echo -e "${RED}Please answer yes or no.\033[0m";;
		esac
	done

	echo -e "\nPut your domain if you will use panel with your domain ${GREEN}[ RECOMMENDED ]\033[0m"
	echo -e "Put [${YELLOW} no-domain \033[0m] if you will use panel with server IP ${RED}[ NOT RECOMMENDED ]\033[0m\n"
	read -p "Put your choice : " DomainC

	if [[ -z ${DomainC} ]]; then
		echo -e "\n${RED}Don't leave field empty, please start install again and put valid domain.\033[0m\n"
		exit -1
	elif [[ ${DomainC} =~ \ + ]]; then
		echo -e "\n${RED}Wrong input don't add space in domain name content, please start install again and put valid domain.\033[0m\n"
		exit -1
	fi

	DomainC=`echo "${DomainC}" | tr '[:upper:]' '[:lower:]'`
	chk_domain=`dig +short ${DomainC} | head -n 1`
	if [ ${DomainC} = "no-domain" ]; then
		SSL_VDO_DOMAIN="IP"
	elif [ ! ${chk_domain} ]; then
		echo -e "\n${RED}Domain not valid, please start install again and put valid domain.\033[0m\n"
		exit -1
	elif [ ${SERV_IP} = ${chk_domain} ]; then
		SSL_VDO_DOMAIN="domain"
	else
		echo -e "\n${RED}Domain not point to the server IP, point your domain to server IP : ${SERV_IP} and try again.\033[0m\n"
		exit -1
	fi

	echo -e "\n${GREEN}Start install VDOPanel system.....\033[0m\n"
	SECONDS=0

	rm -rf /usr/local/src/*
	echo -e "${CYAN}Install Main packages..\033[0m"
	##############################################################
	Install=" - Flush iptables (Firewall).."
	##############################################################
	status_busy "${Install}"
	FLD_CHK=`firewall-cmd --state 2> /dev/null`
	if [[ ${FLD_CHK} == "running" ]]; then
		/bin/systemctl stop firewalld >/dev/null 2>&1 &
		SPINNER;status_busy
		/bin/systemctl disable firewalld >/dev/null 2>&1 &
		SPINNER;status_busy
		/bin/systemctl mask --now firewalld >/dev/null 2>&1 &
		SPINNER;status_busy
	fi
	yum -y install iptables > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	/usr/sbin/iptables -F > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'" "status_done '${Install}'"

	##############################################################
	Install=" - Update server packages.."
	##############################################################
	status_busy "${Install}"
	yum -y update > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'" "status_done '${Install}'"

	##############################################################
	Install=" - Groupinstall Development Tools.."
	##############################################################
	status_busy "${Install}"
	yum -y groupinstall 'Development Tools' > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'" "status_done '${Install}'"

	##############################################################
	Install=" - Epel-release install.."
	##############################################################
	status_busy "${Install}"
	yum -y install epel-release > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'" "status_done '${Install}'"

	##############################################################
	Install=" - Install system packages.."
	##############################################################
	status_busy "${Install}"
	yum -y install wget sudo yum-utils libmaxminddb libmaxminddb-devel git unzip perl perl-devel perl-ExtUtils-Embed \
	libxslt libxslt-devel libxml2 libxml2-devel gd gd-devel pcre-devel GeoIP GeoIP-devel nano certbot python-certbot-nginx \
	httpd-tools iptables-services iftop bc sshpass rsync > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'" "status_done '${Install}'"

	##############################################################
	Install=" - Disable SELInux.."
	##############################################################
	status_busy "${Install}"
	/usr/sbin/setenforce Permissive > ${TMP_F} 2>&1 &
	if [[ -f /etc/selinux/config ]]; then
		DIS_=`cat /etc/selinux/config | grep "SELINUX=enforcing"`
		if [[ ${DIS_} ]]; then
			sed -i "s/SELINUX=enforcing/SELINUX=disabled/g" "/etc/selinux/config" > ${TMP_F} 2>&1 &
		fi
	fi
	SPINNER;status_busy
	status_done '${Install}'

	##############################################################
	Install=" - Install Quota.."
	##############################################################
	status_busy "${Install}"
	Count=0
	yum install -y quota >/dev/null 2>&1 &
	SPINNER;status_busy
	FSTAB_CHK_1=`awk '$2~"^/$"{$4="Z"$4}1' OFS="\t" /etc/fstab | grep Z | grep ext4 | tr -d "Z" | awk {'print $1'}`
	if [[ ${FSTAB_CHK_1} ]]; then
		QuotaCHK=`/usr/bin/mount | grep quota`
		if [[ ${QuotaCHK} ]]; then
			Count=$((Count +1))
			status_done '${Install}'
#			echo -e "\n${GREEN} Quota already installed.\033[0m\n"
		else
			Count=$((Count +1))
			FSTAB_CHK_1_REP=${FSTAB_CHK_1////\\/}
			REP_Q="${FSTAB_CHK_1_REP}	\/	ext4	defaults,usrquota,grpquota  1 1"
			sed -i "/${FSTAB_CHK_1_REP}/c\\${REP_Q}" "/etc/fstab" > ${TMP_F} 2>&1
			/usr/bin/mount -o remount /
			/usr/sbin/quotacheck -cugm /
			status_done '${Install}'
#			echo -e "\n${GREEN} Quota has been installed.\033[0m\n"
		fi
	fi

	FSTAB_CHK_1=`awk '$2~"^/$"{$4="Z"$4}1' OFS="\t" /etc/fstab | grep Z | grep xfs | tr -d "Z" | awk {'print $1'}`
	if [[ ${FSTAB_CHK_1} ]]; then
		grub_CHK=`cat /etc/default/grub | grep GRUB_CMDLINE_LINUX= | grep "rootflags="`
		if [[ ! ${grub_CHK} ]]; then
			Count=$((Count +1))
			grub_F=`cat /etc/default/grub | grep GRUB_CMDLINE_LINUX= | awk '{print $NF}' | tr -d "\""`
			grub_F=${grub_F////\\/}
			grub_REP="${grub_F} rootflags=uquota,pquota"
			sed -i "s/${grub_F}/${grub_REP}/g" "/etc/default/grub"
			/usr/sbin/grub2-mkconfig -o /boot/grub2/grub.cfg > ${TMP_F} 2>&1
		fi
		Count=$((Count +1))
		FSTAB_CHK_1_REP=${FSTAB_CHK_1////\\/}
		REP_Q="${FSTAB_CHK_1_REP}	\/	xfs	defaults,usrquota,grpquota  1 1"
		sed -i "/${FSTAB_CHK_1_REP}/c\\${REP_Q}" "/etc/fstab" > ${TMP_F} 2>&1
		/usr/bin/mount -o remount /
		status_done '${Install}'
	fi

	if [ ${Count} = 0 ]; then
		status_fail '${Install}'
		echo -e "\n${RED} This file system not support Quota or something wrong happened, Please contact support for help.\033[0m"
		echo -e "${YELLOW} Installation will resume without set Quota system.\033[0m\n"
	fi
	


	##############################################################
	Install="\nInstall Streaming packages.."
	##############################################################
	echo -e "${CYAN} ${Install} \033[0m"
	cd /usr/local/src

	##############################################################
	Install=" - Get ngx_http_geoip2_module package.."
	##############################################################
	status_busy "${Install}"
	# https://vdopanel.com/dist/lib/ngx_http_geoip2_module.tar.gz
	wget ${Source_L}/lib/ngx_http_geoip2_module.tar.gz > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	# https://vdopanel.com/dist/geo_db/GeoLite2-City.mmdb
	wget ${Source_L}/geo_db/GeoLite2-City.mmdb > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	# https://vdopanel.com/dist/geo_db/GeoLite2-Country.mmdb
	wget ${Source_L}/geo_db/GeoLite2-Country.mmdb > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'" "status_done '${Install}'"
	Install=" - Extract ngx_http_geoip2_module package.."
	status_busy "${Install}"
	tar -xzf ngx_http_geoip2_module.tar.gz > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'" "status_done '${Install}'"

	##############################################################
	Install=" - Install Nginx and RTMP service.."
	##############################################################
	status_busy "${Install}"
	if rpm -q nginx > /dev/null; then
		yum -y remove nginx > ${TMP_F} 2>&1 &
		SPINNER;status_busy
	fi
	# https://vdopanel.com/dist/lib/vdopanel_nginx-1.18.0.el7.ngx.x86_64.rpm
	yum -y install ${Source_L}/lib/vdopanel_nginx-1.18.0.el7.ngx.x86_64.rpm > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'"
	mkdir -p /varrun >/dev/null 2>&1
	ln -s /usr/lib64/nginx/modules /etc/nginx/modules >/dev/null 2>&1
	/bin/systemctl daemon-reload
	/bin/systemctl start nginx >/dev/null 2>&1
	/bin/systemctl enable nginx >/dev/null 2>&1
	/bin/systemctl enable iptables >/dev/null 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'" "status_done '${Install}'"


	##############################################################
	Install=" - Install MySQL.."
	##############################################################
	status_busy "${Install}"
	mysqladmin ver >/dev/null 2>&1
	if [ $? -ne 0 ]; then
		yum -y localinstall https://dev.mysql.com/get/mysql57-community-release-el7-9.noarch.rpm > ${TMP_F} 2>&1 &
		SPINNER;status_busy
		validation_func "status_fail '${Install}'"

		yum -y install mysql-community-server > ${TMP_F} 2>&1 &
		SPINNER;status_busy
		validation_func "status_fail '${Install}'"

		/bin/systemctl enable mysqld > ${TMP_F} 2>&1 &
		SPINNER;status_busy
		/bin/systemctl start mysqld.service > ${TMP_F} 2>&1 &
		SPINNER;status_busy
		sleep 4 &
		SPINNER;status_busy
		ROOT_PASS=`grep 'A temporary password' /var/log/mysqld.log |tail -1 | awk '{print $NF}'`
		echo -e "[client]\nuser=root\npassword=\x22${ROOT_PASS}\x22" > /root/.my.cnf &
		SPINNER;status_busy
		validation_func "status_fail '${Install}'"
		NEW_SQL_PASS=`head /dev/urandom | tr -dc A-Za-z0-9 | head -c 15 ; echo '@Rx-37'`
		mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED  BY '${NEW_SQL_PASS}'" --connect-expired-password > ${TMP_F} 2>&1 &
		SPINNER;status_busy
		validation_func "status_fail '${Install}'"
		echo -e "[client]\nuser=root\npassword=\x22${NEW_SQL_PASS}\x22" > /root/.my.cnf
		status_done "${Install}"
	else
		status_done "${Install}"
#		echo -e "${GREEN} MySQL already installed..\033[0m\n"
	fi


	##############################################################
	Install=" - Install php and ioncube_loaders.."
	##############################################################
	cd /usr/local/src
	status_busy "${Install}"
	yum -y install http://rpms.remirepo.net/enterprise/remi-release-7.rpm > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	yum-config-manager --enable remi-php74 > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'"

	yum -y install php php-fpm php-gd php-json php-mbstring php-mysqlnd php-xml php-xmlrpc php-opcache php-cli > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'"
# https://vdopanel.com/dist/lib/ioncube_loaders_lin_x86-64.tar.gz
	wget ${Source_L}/lib/ioncube_loaders_lin_x86-64.tar.gz > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'"

	tar -xzf ioncube_loaders_lin_x86-64.tar.gz > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'"

	scp ioncube/ioncube_loader_lin_7.4.so /usr/lib64/php/modules > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'"

	chmod 755 /usr/lib64/php/modules/ioncube_loader_lin_7.4.so
	# https://vdopanel.com/dist/config/php74-www.conf.txt
	curl -s ${Source_L}/config/php74-www.conf.txt > /etc/php-fpm.d/www.conf &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'"
# https://vdopanel.com/dist/config/php74.conf.txt
	curl -s ${Source_L}/config/php74.conf.txt > /etc/php.ini &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'"

	status_done '${Install}'
	/bin/systemctl restart nginx >/dev/null 2>&1
	/bin/systemctl enable php-fpm >/dev/null 2>&1
	/bin/systemctl restart php-fpm.service >/dev/null 2>&1


	##############################################################
	Install=" - Disable IPv6.."
	##############################################################
	status_busy "${Install}"
	IP6_CHK=`cat /etc/sysctl.conf | grep 'net.ipv6.conf.all.disable_ipv6'`
	if [[ ! ${IP6_CHK} ]]; then
		echo "net.ipv6.conf.all.disable_ipv6 = 1" >> /etc/sysctl.conf
		echo "net.ipv6.conf.default.disable_ipv6 = 1" >> /etc/sysctl.conf
		/usr/sbin/sysctl -p > ${TMP_F} 2>&1
		status_done '${Install}'
	else
		status_done '${Install}'
#		echo -e "${GREEN} SUCCESS : ${Install} already installed..\033[0m\n"
	fi

	##############################################################
	Install=" - Install FTP server.."
	##############################################################
	status_busy "${Install}"
	cd /usr/local/src
	yum -y install vsftpd > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'"
	/bin/systemctl start vsftpd >/dev/null 2>&1
	/bin/systemctl enable vsftpd >/dev/null 2>&1
	if [ ! -d /etc/vsftpd/users_config ];then
		mkdir /etc/vsftpd/users_config
	fi
	# https://vdopanel.com/dist/config/ftp.conf.txt
	curl -s ${Source_L}/config/ftp.conf.txt > /etc/vsftpd/vsftpd.conf &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'"
	/bin/systemctl restart vsftpd > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'" "status_done '${Install}'"


	##############################################################
	Install=" - Install FFMPEG and Streaming packages.."
	##############################################################
	status_busy "${Install}"
	yum -y install youtube-dl > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'"
	# https://vdopanel.com/dist/lib/yt-dlp
	curl -s ${Source_L}/lib/yt-dlp > /usr/local/bin/yt-dlp &
	SPINNER;status_busy
	validation_func "status_fail '${STEP_}'"
	chmod +x /usr/local/bin/yt-dlp > ${TMP_F} 2>&1
	/usr/local/bin/yt-dlp -U > ${TMP_F} 2>&1 &
	SPINNER;status_busy

	yum -y localinstall --nogpgcheck https://download1.rpmfusion.org/free/el/rpmfusion-free-release-7.noarch.rpm > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	yum -y install yasm frei0r-devel frei0r-plugins gnutls-devel libass-devel lame-devel x264-devel > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'"

	if ! rpm -q ffmpeg > /dev/null; then
	# https://vdopanel.com/dist/lib/vdopanel_ffmpeg-4.2.4-0.x86_64.rpm
		yum -y install ${Source_L}/lib/vdopanel_ffmpeg-4.2.4-0.x86_64.rpm > ${TMP_F} 2>&1 &
		SPINNER;status_busy
		validation_func "status_fail '${Install}'"
	fi
	sleep 1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'" "status_done '${Install}'"


	##############################################################
	Install=" - Install Stunnel.."
	##############################################################
	status_busy "${Install}"
	yum -y install stunnel psmisc > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'"
	mkdir -p /var/run/stunnel > ${TMP_F} 2>&1
	chmod 777 /var/run/stunnel > ${TMP_F} 2>&1
	echo > /var/log/stunnel.log > ${TMP_F} 2>&1
	chmod 777 /var/log/stunnel.log > ${TMP_F} 2>&1
	# https://vdopanel.com/dist/config/stunnel.service.txt
	curl -s ${Source_L}/config/stunnel.service.txt > /lib/systemd/system/stunnel.service &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'"
	# https://vdopanel.com/dist/config/stunnel.conf.txt
	curl -s ${Source_L}/config/stunnel.conf.txt > /etc/stunnel/stunnel.conf &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'"
	/bin/systemctl enable stunnel.service > ${TMP_F} 2>&1
	/bin/systemctl daemon-reload > ${TMP_F} 2>&1
	/bin/systemctl start stunnel > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'" "status_done '${Install}'"


        ##############################################################
        Install=" - Install goaccess.."
        ##############################################################
	status_busy "${Install}"
	cd /usr/local/src
	yum -y install openssl-devel ncurses-devel > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'"
	# https://vdopanel.com/dist/lib/goaccess-1.5.2.tar.gz
	wget ${Source_L}/lib/goaccess-1.5.2.tar.gz > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'"
	tar -xzf goaccess-1.5.2.tar.gz > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'"
	cd goaccess-1.5.2
	./configure --enable-debug --enable-utf8 --enable-geoip=mmdb --enable-tcb=memhash --with-getline --with-openssl > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'"
	make > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	make install > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	# https://vdopanel.com/dist/config/goaccess1.5.conf.txt
	curl -s ${Source_L}/config/goaccess1.5.conf.txt > /usr/local/etc/goaccess/goaccess.conf &
	SPINNER;status_busy
	validation_func "status_fail '${Install}'" "status_done '${Install}'"


	##############################################################
	Install="\nInstall and Configure VDOpanel UI.."
	##############################################################
	echo -e "${CYAN} ${Install} \033[0m"
	cd /usr/local/src
	VDO_SYS_USER="vdopanel"
	if [ -d /home/${VDO_SYS_USER} ];then
		/bin/systemctl stop nginx > /dev/null 2>&1
		/bin/systemctl stop php-fpm.service >/dev/null 2>&1
		/usr/sbin/userdel -r ${VDO_SYS_USER} > ${TMP_F} 2>&1
		rm -rf /home/${VDO_SYS_USER}
	fi
	STEP_=" - Add vdopanel user.."
	status_busy "${STEP_}"
	/usr/sbin/groupadd ${VDO_SYS_USER} >/dev/null 2>&1
	/usr/sbin/useradd ${VDO_SYS_USER} -g ${VDO_SYS_USER} > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${STEP_}'" "status_done '${STEP_}'"

	chown -R ${VDO_SYS_USER}.${VDO_SYS_USER} /var/lib/php/session/ >/dev/null 2>&1
	chown -R ${VDO_SYS_USER}.${VDO_SYS_USER} /var/cache/nginx/ >/dev/null 2>&1
	chown -R ${VDO_SYS_USER}.${VDO_SYS_USER} /var/cache/nginxfastcgi_temp/* >/dev/null 2>&1

	RAND_PASS=`date +%s | sha256sum | base64 | head -c 12`
	echo ${RAND_PASS} | passwd ${VDO_SYS_USER} --stdin > ${TMP_F} 2>&1
	DIS_SSH_FSTP=`egrep "DenyGroups vdopanel" /etc/ssh/sshd_config`
	if [[ ! ${DIS_SSH_FSTP} ]]; then
		echo "DenyGroups vdopanel" >> /etc/ssh/sshd_config
		/bin/systemctl restart sshd.service >/dev/null 2>&1
	fi

	STEP_=" - Get vdopanel files.."
	status_busy "${STEP_}"
	# https://vdopanel.com/dist/vdopanel.tar.gz
	wget ${Source_L}/vdopanel.tar.gz > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${STEP_}'" "status_done '${STEP_}'"

	STEP_=" - Extract vdopanel files.."
	status_busy "${STEP_}"
	tar -xzf vdopanel.tar.gz > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${STEP_}'" "status_done '${STEP_}'"

	STEP_=" - Copy vdopanel files.."
	status_busy "${STEP_}"
	mv vdopanel/core/vdopanel /usr/local/bin/
	chmod +x /usr/local/bin/vdopanel
	cp -r vdopanel/public_html vdopanel/core /home/${VDO_SYS_USER} &
	SPINNER;status_busy
	validation_func "status_fail '${STEP_}'" "status_done '${STEP_}'"

	chown -R ${VDO_SYS_USER}.${VDO_SYS_USER} /home/${VDO_SYS_USER}/public_html > ${TMP_F} 2>&1
	chown ${VDO_SYS_USER}.${VDO_SYS_USER} /home/${VDO_SYS_USER}/core > ${TMP_F} 2>&1
	for i in `ls /home/${VDO_SYS_USER}/core/*`
	do
		if [ -f ${i} ]; then
			chmod +x ${i} > ${TMP_F} 2>&1
		fi
	done
	chmod 777 -R /home/${VDO_SYS_USER}/core/tmp > ${TMP_F} 2>&1
	mkdir -p /etc/nginx/loadb > ${TMP_F} 2>&1
	mkdir -p /etc/nginx/geoip > ${TMP_F} 2>&1
	mv GeoLite2-City.mmdb /etc/nginx/geoip > ${TMP_F} 2>&1
	mv GeoLite2-Country.mmdb /etc/nginx/geoip > ${TMP_F} 2>&1
	cat /home/${VDO_SYS_USER}/core/conf-templates/nginx-mainconf.conf > /etc/nginx/nginx.conf
	sed -i "s/_IP_/${SERV_IP}/g" "/etc/nginx/nginx.conf" > ${TMP_F} 2>&1
	WORKER_N=`/usr/bin/nproc`
	sed -i "s/_WORKER_NUM_/${WORKER_N}/g" "/etc/nginx/nginx.conf"
	sed -i "s/_UOWNER_/${VDO_SYS_USER}/g" "/etc/nginx/nginx.conf"
	chmod 755 /home/${VDO_SYS_USER} > ${TMP_F} 2>&1
	chmod 777 -R /home/${VDO_SYS_USER}/public_html/storage/framework > ${TMP_F} 2>&1
	chmod 777 -R /home/${VDO_SYS_USER}/public_html/storage/logs > ${TMP_F} 2>&1
	chmod 777 -R /home/${VDO_SYS_USER}/public_html/public/uploads > ${TMP_F} 2>&1

	STEP_=" - Restart nginx service.."
	status_busy "${STEP_}"
	/bin/systemctl restart nginx.service > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${STEP_}'" "status_done '${STEP_}'"

	DB_NAME="vdopanel_db"
	DB_USER="vdopanel_user1"
	if [ -d /var/lib/mysql/${DB_NAME} ]; then
		STEP_=" - Delete ${VDO_SYS_USER} old database.."
		status_busy "${STEP_}"
		mysql -e "drop database ${DB_NAME}" > ${TMP_F} 2>&1 &
		SPINNER;status_busy
		validation_func "status_fail '${STEP_}'" "status_done '${STEP_}'"
		mysql -e "drop user '${DB_USER}'@'localhost'" >/dev/null 2>&1
	fi

	STEP_=" - Create ${VDO_SYS_USER} database.."
	status_busy "${STEP_}"
	mysql -e "create database ${DB_NAME}" > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${STEP_}'" "status_done '${STEP_}'"

	STEP_=" - Create ${VDO_SYS_USER} database user.."
	status_busy "${STEP_}"
	RAND_PASS_DB=`head /dev/urandom | tr -dc A-Za-z0-9 | head -c 15 ; echo '@Rx-37'`
	mysql -e "CREATE USER '${DB_USER}'@'localhost' IDENTIFIED BY '${RAND_PASS_DB}'" > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${STEP_}'" "status_done '${STEP_}'"

	STEP_=" - Grant privileges ${VDO_SYS_USER} database.."
	status_busy "${STEP_}"
	mysql -e "GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '${DB_USER}'@'localhost'" > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${STEP_}'" "status_done '${STEP_}'"

	STEP_=" - Restore ${VDO_SYS_USER} database.."
	status_busy "${STEP_}"
	mysql ${DB_NAME} < vdopanel/database/vdopanel_db.sql > ${TMP_F} 2>&1 &
	SPINNER;status_busy
	validation_func "status_fail '${STEP_}'" "status_done '${STEP_}'"

	sed -i "s/_PASSWORD_/${RAND_PASS_DB}/g" "/home/${VDO_SYS_USER}/public_html/.env"
	sudoers_chk=`cat /etc/sudoers | grep vdopanel`
	if [[ ! ${sudoers_chk} ]]; then
		STEP_=" - Set sudoers ${VDO_SYS_USER} files.."
		status_busy "${STEP_}"
		cat /home/${VDO_SYS_USER}/core/conf-templates/sudoers.conf >> /etc/sudoers
		sed -i "s/_S_OWNER_/${VDO_SYS_USER}/g" "/etc/sudoers"
		sed -i "s/_S_USER_/${VDO_SYS_USER}/g" "/etc/sudoers" &
		SPINNER;status_busy
		validation_func "status_fail '${STEP_}'" "status_done '${STEP_}'"
		rm -rf /home/${VDO_SYS_USER}/core/conf-templates/sudoers.conf > ${TMP_F} 2>&1
	fi

	##############################################################
	###### Set CronJob..
	##############################################################
	CronCHK=`cat /etc/crontab | grep artisan`
	if [[ ! ${CronCHK} ]]; then
		STEP_=" - Set CronJob.."
		status_busy "${STEP_}"
		echo "* * * * * root for i in {1..6}; do /usr/bin/php /home/vdopanel/public_html/artisan schedule:run > /dev/null 2>&1 & sleep 10 > /dev/null 2>&1;done" >> /etc/crontab
		echo "*/10 * * * * root /home/vdopanel/core/utils clearlogs > /dev/null 2>&1" >> /etc/crontab
		echo "0 1 1 * * root /home/vdopanel/core/utils bandwidthreset all > /dev/null 2>&1" >> /etc/crontab
		echo "* * * * * root /home/vdopanel/core/utils vdocron > /dev/null 2>&1" >> /etc/crontab
		echo "0 1 * * * root /home/vdopanel/core/utils sslcheck > /dev/null 2>&1" >> /etc/crontab
		echo "0 2 * * * root /home/vdopanel/core/utils dobackup scheduling > /dev/null 2>&1" >> /etc/crontab &
		SPINNER;status_busy
		validation_func "status_fail '${STEP_}'" "status_done '${STEP_}'"
	fi


	NGX_CONF="/etc/nginx/conf.d"
	mkdir -p ${NGX_CONF} > ${TMP_F} 2>&1

	if [ ${SSL_VDO_DOMAIN} = "domain" ]; then
		sed -i "s/_SITE_URL_/${DomainC}/g" "/home/${VDO_SYS_USER}/public_html/.env"
		SOU_CONF="/home/${VDO_SYS_USER}/core/conf-templates"
		cat ${SOU_CONF}/domains.conf > ${NGX_CONF}/${DomainC}.http
		sed -i "s/_USER_/${VDO_SYS_USER}_mainconf/g" "${NGX_CONF}/${DomainC}.http"
		sed -i "s/_DOMAIN_/${DomainC}/g" "${NGX_CONF}/${DomainC}.http"
		STEP_=" - Set Nginx vhost and reload nginx.."
		status_busy "${STEP_}"
		/bin/systemctl reload nginx.service > ${TMP_F} 2>&1 &
		SPINNER;status_busy
		validation_func "status_fail '${STEP_}'" "status_done '${STEP_}'"

		STEP_=" - Set SSL for domain.."
		status_busy "${STEP_}"
		certbot certonly --nginx -d "${DomainC}" --non-interactive --agree-tos  --register-unsafely-without-email > ${TMP_F} 2>&1 &
		SPINNER;status_busy
		validation_func "status_fail '${STEP_}'" "status_done '${STEP_}'"

		cat ${SOU_CONF}/domains-ssl.conf > ${NGX_CONF}/${DomainC}_ssl.http
		sed -i "s/_USER_/${VDO_SYS_USER}_mainconf/g" "${NGX_CONF}/${DomainC}_ssl.http"
		sed -i "s/_DOMAIN_/${DomainC}/g" "${NGX_CONF}/${DomainC}_ssl.http"

		STEP_=" - Reload nginx service.."
		status_busy "${STEP_}"
		/bin/systemctl reload nginx.service > ${TMP_F} 2>&1 &
		SPINNER;status_busy
		validation_func "status_fail '${STEP_}'" "status_done '${STEP_}'"
		/bin/systemctl restart php-fpm.service > /dev/null 2>&1
	fi

	if [ ${SSL_VDO_DOMAIN} = "IP" ]; then
		DomainC=${SERV_IP}
		STEP_=" - Set vhost files and reload nginx.."
		status_busy "${STEP_}"
		sed -i "s/_SITE_URL_/${DomainC}/g" "/home/${VDO_SYS_USER}/public_html/.env"
		SOU_CONF="/home/${VDO_SYS_USER}/core/conf-templates"
		cat ${SOU_CONF}/domains.conf > ${NGX_CONF}/vdopanel_IP.http
		sed -i "s/_USER_/${VDO_SYS_USER}_mainconf/g" "${NGX_CONF}/vdopanel_IP.http"
		sed -i "s/_DOMAIN_/${DomainC}/g" "${NGX_CONF}/vdopanel_IP.http"
		cat ${SOU_CONF}/IP-ssl.conf > ${NGX_CONF}/vdopanel_IP_ssl.http
		sed -i "s/_USER_/${VDO_SYS_USER}_mainconf/g" "${NGX_CONF}/vdopanel_IP_ssl.http"
		sed -i "s/_IP_/${DomainC}/g" "${NGX_CONF}/vdopanel_IP_ssl.http"
		/bin/systemctl reload nginx.service > ${TMP_F} 2>&1 &
		SPINNER;status_busy
		validation_func "status_fail '${STEP_}'" "status_done '${STEP_}'"
		/bin/systemctl restart php-fpm.service > /dev/null 2>&1
	fi


	STEP_=" - Set admin info.."
	status_busy "${STEP_}"
	RAND_P1=`date +%s | sha256sum | base64 | head -c 12`
	RAND_P2=`htpasswd -nbBC 10 USER ${RAND_P1} | cut -d":" -f2`
	adminuser=`mysql ${DB_NAME} -e "SELECT name FROM users WHERE id='1'\G" | awk '{print $2}' | tr -d "1.\n"`
	mysql ${DB_NAME} -e "UPDATE users SET password = '${RAND_P2}' WHERE id='1'"
	mysql ${DB_NAME} -e "UPDATE users SET domain = '${DomainC}' WHERE id='1'"
	mysql ${DB_NAME} -e "UPDATE brandings SET domain = '${DomainC}' WHERE id='1'" &
	SPINNER;status_busy
	validation_func "status_fail '${STEP_}'" "status_done '${STEP_}'"

	Trial_L="VDOPanel-Trial-de6g65b641h89e03w"
	mysql ${DB_NAME} -e "UPDATE users SET licence = '${Trial_L}' WHERE id='1'"

	echo -e "\n${GREEN}Installation done.\033[0m"
	Elapsed_T=`Elapsed_T_FUNC ${SECONDS}`
	echo -e "Elapsed time in installation : ${Elapsed_T}\n"
	echo -e "#################################################################" 1>&2
	echo -e "#                                                               #" 1>&2
	echo -e "#      Congratulations!                                         #" 1>&2
	echo -e "#      You successfully installed VDOpanel system               #" 1>&2
	echo -e "#      URL : http://${DomainC}/portal                           \033[65G#" 1>&2
	echo -e "#      SSL URL : https://${DomainC}/portal                      \033[65G#" 1>&2
	echo -e "#      Now, you can log on your panel with the admin info       #" 1>&2
	echo -e "#      Username : ${adminuser}                                  \033[65G#" 1>&2
	echo -e "#      Password : ${RAND_P1}                                    \033[65G#" 1>&2
	echo -e "#                                                               #" 1>&2
	echo -e "#################################################################" 1>&2
	echo -e "\n"

	service iptables save >/dev/null 2>&1

	if [ ${Count} != 0 ]; then
		echo -e "\n${CYAN} Please reboot your server to active Quota system.\n Reboot Command : reboot\033[0m\n"
	fi

elif [ $choose = "uninstall" ]; then
	status_done()
	{
	  echo -e "${STATUS_POSITION}${GREEN} [ uninstall done ]\033[0m${NOCOL}"
	}

	echo -e "\n${RED}Are you sure you want uninstall VDO Panel software ?\033[0m \
		\nIf you confirm that will be lost all data in VDO Panel software\n"
	while true
	do
		read -p "Put [ y ] to confirm uninstall ? [y/n] : " yn
		case $yn in
		[Yy]* )
		break;;
		[Nn]* ) echo -e "Uninstallation has been canceled.\n";exit;;
		* ) echo -e "${RED}Please answer yes or no.\033[0m";;
		esac
	done
	echo -e "\n${GREEN}Start uninstall VDO Panel software.....\033[0m\n"

	STEP_=" - Delete VDO Panel system users.."
	status_busy "${STEP_}"
	/bin/systemctl stop nginx > /dev/null 2>&1
	/bin/systemctl stop php-fpm.service > /dev/null 2>&1
	cd /home
	for i in `ls /home`
	do
		if [ -d ${i} ]; then
			userdel -r ${i} > ${TMP_F} 2>&1
		fi
	done
	groupdel vdopanel > ${TMP_F} 2>&1
	status_done "${STEP_}"

	STEP_=" - Delete VDO Panel database.."
	status_busy "${STEP_}"
	mysql -e "drop database vdopanel_db" > ${TMP_F} 2>&1
	mysql -e "drop user 'vdopanel_user1'@'localhost'" > ${TMP_F} 2>&1
	status_done "${STEP_}"

	STEP_=" - Delete VDO Panel conf files.."
	status_busy "${STEP_}"
	rm -rf /etc/nginx/conf.d/*
	rm -rf /etc/vsftpd/users_config/*
	sed -i '/vdopanel\/core/d' /etc/crontab > ${TMP_F} 2>&1
	sed -i '/artisan/d' /etc/crontab > ${TMP_F} 2>&1
	sed -i '/vdopanel\/core/d' /etc/sudoers > ${TMP_F} 2>&1
	sed -i '/bin\/ffmpeg/d' /etc/sudoers > ${TMP_F} 2>&1
	sed -i '/bin\/ffprobe/d' /etc/sudoers > ${TMP_F} 2>&1
	rm -rf /usr/local/bin/vdopanel /etc/stunnel/stunnel.conf
	G_COLOR1="--color"
	G_COLOR2="=auto"
	G_COLOR_="${G_COLOR1}${G_COLOR2}"
	for i in `ps -aux | grep "\/home\/vdopanel\/core\/ffmpegrun" | grep -v "grep ${G_COLOR_}" | grep -v "status_done" |  awk '{print $2}'`
	do
		kill -9 ${i} > ${TMP_F} 2>&1
	done
	for i in `ps -aux | grep "\/home\/vdopanel\/core\/utils" | grep -v "grep ${G_COLOR_}" | grep -v "status_done" |  awk '{print $2}'`
	do
		kill -9 ${i} > ${TMP_F} 2>&1
	done
	status_done "${STEP_}"
	echo -e "\n${GREEN}Uninstall done.\033[0m\n"

else
	echo -e "\nUnknown input."
	echo -e "\n${GREEN}Options :\033[0m\n\nStart install with this command : ./install.bin start\nfor uninstall : ./install.bin uninstall\n"
fi
